#!/usr/bin/python
"""
Arguments:

    <cachesize>         Size of squid cache (in megabytes)

Environment variables:

    TKLBAM_SQUID_CACHE_DIR      location of cache dir (default: %s)
    TKLBAM_SQUID_USER           user under which we execute squid (default: %s)
    TKLBAM_SQUID_BIN            path to tklbam squid binary (default: %s)

"""

import os
import sys
import string

from executil import system
from temp import TempFile

TKLBAM_SQUID_BIN = "/usr/lib/tklbam/deps"
TKLBAM_SQUID_CACHE_DIR = "/var/spool/tklbam-squid"
TKLBAM_SQUID_USER = "proxy"
TKLBAM_SQUID_BIN = "/usr/lib/tklbam/deps/usr/sbin/squid"

TKLBAM_CONF_TPL = \
"""
# autogenerated file, do not edit

cache_dir ufs $CACHE_DIR $CACHE_SIZE 16 256
maximum_object_size $MAXIMUM_OBJECT_SIZE MB

# static

http_port 127.0.0.1:$PORT
icp_port 0

acl all src all
acl localhost src 127.0.0.1/32

http_access allow localhost
http_access deny all

cache_mem 0 MB
maximum_object_size_in_memory 0 KB

refresh_pattern -i duplicity.*\.gpg$$ 86400 90% 604800 ignore-auth

cache_log /dev/null
access_log none
cache_store_log none
pid_filename none
netdb_filename none
"""

class Error(Exception):
    pass

def usage(e=None):
    if e:   
        print >> sys.stderr, "error: " + str(e)
    print >> sys.stderr, "Syntax: %s <port> <cache_size>" % sys.argv[0]
    print >> sys.stderr, __doc__.strip() % (TKLBAM_SQUID_CACHE_DIR, TKLBAM_SQUID_USER, TKLBAM_SQUID_BIN)
    sys.exit(1)

def main():
    args = sys.argv[1:]
    if len(args) != 2:
        usage("incorrect number of arguments")

    try:
        port = int(args[0])
    except ValueError:
        usage("bad port '%s'" % args[0])

    try:
        cache_size = int(args[1])
    except ValueError:
        usage("bad cache_size '%s'" % args[1])

    cache_dir = os.environ.get('TKLBAM_SQUID_CACHE_DIR', TKLBAM_SQUID_CACHE_DIR)
    user = os.environ.get('TKLBAM_SQUID_USER', TKLBAM_SQUID_USER)
    
    conf_tpl = string.Template(TKLBAM_CONF_TPL)
    conf = conf_tpl.substitute(PORT=port, 
                               CACHE_DIR=cache_dir, 
                               CACHE_SIZE=cache_size + 16, 
                               MAXIMUM_OBJECT_SIZE=cache_size)

    conf_tmp = TempFile("tklbam-squid-conf-")
    file(conf_tmp.path, "w").write(conf)
    os.chmod(conf_tmp.path, 0644)

    system("su %s -c" % user, "%s -f %s -z" % (TKLBAM_SQUID_BIN, conf_tmp.path))
    system("su %s -c" % user, "%s -f %s -N -d 1" % (TKLBAM_SQUID_BIN, conf_tmp.path))

if __name__ == "__main__":
    main()
